name: Percona CVE Actions
on: workflow_dispatch
jobs:
  tags-generation:
    name: Generating versions list
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.setmatrix.outputs.matrix }}
    steps:
      - name: Get data from docker hub
        id: getdata
        run: |
           content=`curl "https://hub.docker.com/v2/repositories/library/percona/tags/?page_size=5&name&ordering"`
           echo "content=$content" >> $GITHUB_OUTPUT
      - name: Set dynamic matrix
        id: setmatrix
        run: |
          echo ${{fromJson(steps.getdata.outputs.content).result}}
          echo "matrix=${{fromJson(steps.getdata.outputs.content).result}}" >> $GITHUB_OUTPUT
  trivy-testing:
    name: Testing repositries on Trivy
    needs: tags-generation
    runs-on: ubuntu-latest
    strategy:
      matrix: ${{fromJson(needs.tags-generation.outputs.matrix) }}
    steps:
      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: 'percona:${{ matrix.name }}'
          format: 'table'
          exit-code: '1'
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'CRITICAL,HIGH'
